{
  "url": "https://shipany.ai/zh/docs/deploy/cloudflare",
  "title": "部署到 Cloudflare Workers",
  "content": "基于 ShipAny 开发的项目支持部署到 Cloudflare Workers。利用 Cloudflare Workers 的 Serverless 特性，可以实现高可用、低成本的部署。\n\n按照以下步骤完成 Cloudflare Workers 的适配与部署。\n\n让你的项目能正常运行在 Cloudflare Workers 上，需要做项目适配，一般有三种情况。\n\n在参考 快速开始 初始化项目时，选择拉取 cf 分支的代码。此分支代码已适配 Cloudflare Workers，在此基础上开发的项目，可一键部署到 Cloudflare Workers。\n\n如果你的项目是基于 main 分支或 dev 分支创建的，一开始是部署到 Vercel 等平台，后来需要重新部署到 Cloudflare Workers，你可以选择合并适配好的分支代码，完成项目适配。\n\n请注意：直接合并上游分支代码可能会遇到冲突，需要手动解决冲突。\n\n如果你的已有项目，相较于上游项目，有较大的改动，不适合直接合并上游仓库代码。你可以参考 OpenNext 文档，自行适配。\n\n按照文档示例的步骤一步步操作，完成项目适配。\n\n请注意：OpenNext 目前不支持 Next.js 16，在适配前请先把项目降级到 Next.js 15.5.5。\n\n在完成上述的项目适配流程后，就可以按照下面的步骤，将你的项目部署到 Cloudflare Workers 了。\n\n在项目根目录创建一个 .env.production 文件。可以手动创建，也可以通过下面的命令创建。\n\n把 .env.production 文件中的环境变量值，改成线上环境配置。\n\n在项目根目录创建一个 wrangler.toml 文件。可以手动创建，也可以通过下面的命令创建。\n\n然后修改 wrangler.toml 文件中的内容，根据你的项目在线上部署的情况，修改对应的变量值。\n\n复制上一步设置的 .env.production 文件中的内容，替换掉 wrangler.toml 文件中 [vars] 下面的内容。\n\n注意：第一次部署时，我们先注释掉 wrangler.toml 文件中的 [[hyperdrive]] 配置，等部署完成后再来设置。Cloudflare Workers 是 Serverless 平台，不支持数据库单例模式，确保设置 DB_SINGLETON_ENABLED = \"false\"\n\n在项目根目录下执行以下命令，安装项目依赖。\n\n依赖安装完后，会自动安装 wrangler 命令行工具。\n\n然后在项目根目录下执行以下命令，部署项目到 Cloudflare Workers。\n\n如果是第一次部署项目到 Cloudflare Workers，命令行会输出 Cloudflare 的授权地址。你需要点击打开链接，在浏览器登录你的 Cloudflare 账户，完成对项目的授权。\n\n授权完成后，部署命令会继续执行，编译项目代码，上传部署文件，最终把你的项目发布到 Cloudflare Workers，并输出预览地址。\n\n至此，项目已经成功部署到 Cloudflare Workers。打开输出的预览地址，就可以看到项目页面了。\n\n接下来，你可以通过 绑定自定义域名、配置 Hyperdrive 等操作，让项目正式上线运营。\n\n如果你的域名是在其他域名服务商（Godaddy、Namecheap 等）注册的，你可以选择在 Cloudflare 添加自定义域名。\n\n然后去你的域名管理后台，把域名的 NAMESERVER 设置为 Cloudflare 提供的 Nameservers\n\n域名托管到 Cloudflare 后，可以使用 Cloudflare 提供的 DNS 解析、SSL 证书、CDN 加速等功能。\n\n进入部署在 Cloudflare Workers 的项目管理页面，进入 Settings -> Domains & Routers 页面，点击 Add 按钮，选择 Custom Domain，输入你的自定义域名（可以是托管在 Cloudflare 的根域名，或者子域名），点击 Add Domain 按钮，添加自定义域名。\n\n上一步添加自定义域名后，Cloudflare 会自动为域名添加到 Cloudflare Workers 的 DNS 解析记录。等 DNS 解析生效（一般半小时内生效，最多可能需要 48 小时），就可以通过自定义域名访问你的项目了。\n\nHyperdrive 是一项由 Cloudflare 提供的，用于加速全球用户对现有数据库访问的服务。\n\n通过以下步骤配置 Hyperdrive，加快 Cloudflare Workers 上部署的项目对外部数据库的访问速度。\n\n进入 Cloudflare 控制台，在 Storage & databases -> Hyperdrive 页面点击 Create configuration 按钮，创建 Hyperdrive 配置。\n\n在创建 Hyperdrive 配置页面，选择 Connect to public database，然后填入数据库配置信息。\n\nConfiguration name 是给你自己看的配置名称，填什么无所谓。\n\nConnection String 要填写项目线上环境的数据库连接地址。\n\n在 Hyperdrive 配置管理页面，复制 Hyperdrive 配置 ID。\n\n修改项目根目录下的 wrangler.toml 文件，开启 [[hyperdrive]] 配置，填入 Hyperdrive 配置 ID 和线上环境的数据库连接地址。\n\n在项目根目录下执行以下命令，重新部署项目。\n\n重新部署项目后，项目会自动使用 Hyperdrive 加速数据库访问。可以在 Hyperdrive 管理页面，看到数据查询请求的统计信息。\n\n在 Cloudflare 控制台，进入 Workers & Pages 页面，选择部署在 Cloudflare Workers 的项目，进入项目管理页面。\n\n点击 Observability 标签进入项目运行日志页面。可以在此处查看项目运行过程中输出的系统日志和调试内容。\n\n如果你希望通过日志排查问题，可以在项目代码里面通过 console.log 打印调试日志，重新部署上线。\n\n然后在 Observability 页面点击 Live 按钮，监听实时输出的日志内容。刷新线上访问地址，查看日志输出，根据日志内容定位具体问题。",
  "headings": [
    {
      "level": "h1",
      "text": "部署到 Cloudflare Workers",
      "id": ""
    },
    {
      "level": "h2",
      "text": "项目适配",
      "id": "项目适配"
    },
    {
      "level": "h2",
      "text": "项目部署",
      "id": "项目部署"
    },
    {
      "level": "h2",
      "text": "绑定自定义域名",
      "id": "绑定自定义域名"
    },
    {
      "level": "h2",
      "text": "配置 Hyperdrive",
      "id": "配置-hyperdrive"
    },
    {
      "level": "h2",
      "text": "查看项目运行日志",
      "id": "查看项目运行日志"
    }
  ],
  "code_samples": [
    {
      "code": "git clone -b cf git@github.com:shipanyai/shipany-template-two my-shipany-project",
      "language": "python"
    },
    {
      "code": "# 为你的项目创建新分支\ngit checkout -b cf\n# 把 ShipAny 仓库代码设为上游\ngit remote add upstream git@github.com:shipanyai/shipany-template-two.git\n# 拉取上游仓库的更新\ngit fetch upstream\n# 合并上游仓库指定分支的更新\ngit merge upstream/cf",
      "language": "markdown"
    },
    {
      "code": "cp .env.example .env.production",
      "language": "unknown"
    },
    {
      "code": "# app\nNEXT_PUBLIC_APP_URL = \"https://your-domain.com\"\nNEXT_PUBLIC_APP_NAME = \"Your App Name\"\n\n# theme\nNEXT_PUBLIC_THEME = \"default\"\n\n# appearance\nNEXT_PUBLIC_APPEARANCE = \"dark\"\n\n# database\nDATABASE_URL = \"postgresql://user:password@domain:port/database\"\nDATABASE_PROVIDER = \"postgresql\"\nDB_SINGLETON_ENABLED = \"false\"\n\n# auth secret\n# openssl rand -base64 32\nAUTH_SECRET = \"your-secret-key\"",
      "language": "markdown"
    },
    {
      "code": "cp wrangler.toml.example wrangler.toml",
      "language": "unknown"
    },
    {
      "code": "name = \"your-app-name\"\nmain = \".open-next/worker.js\"\ncompatibility_date = \"2025-03-01\"\ncompatibility_flags = [\"nodejs_compat\"]\n\n[assets]\nbinding = \"ASSETS\"\ndirectory = \".open-next/assets\"\n\n# [[hyperdrive]]\n# binding = \"HYPERDRIVE\"\n# id = \"\"\n# localConnectionString = \"\"\n\n[observability]\nenabled = true\n\n[vars]\n# app\nNEXT_PUBLIC_APP_URL = \"https://your-domain.com\"\nNEXT_PUBLIC_APP_NAME = \"Your App Name\"\n\n# theme\nNEXT_PUBLIC_THEME = \"default\"\n\n# appearance\nNEXT_PUBLIC_APPEARANCE = \"dark\"\n\n# database\nDATABASE_URL = \"postgresql://user:password@domain:port/database\"\nDATABASE_PROVIDER = \"postgresql\"\nDB_SINGLETON_ENABLED = \"false\"\n\n# auth secret\n# openssl rand -base64 32\nAUTH_SECRET = \"your-secret-key\"",
      "language": "json"
    },
    {
      "code": "pnpm install",
      "language": "unknown"
    },
    {
      "code": "pnpm cf:deploy",
      "language": "unknown"
    },
    {
      "code": "graham.ns.cloudflare.com\nullis.ns.cloudflare.com",
      "language": "unknown"
    },
    {
      "code": "[[hyperdrive]]\nbinding = \"HYPERDRIVE\" # 固定值，不要修改\nid = \"your-hyperdrive-config-id\" # 填入上一步复制的 Hyperdrive 配置 ID\nlocalConnectionString = \"postgresql://user:password@domain:port/database\" # 填入线上环境的数据库连接地址",
      "language": "json"
    },
    {
      "code": "pnpm cf:deploy",
      "language": "unknown"
    }
  ],
  "patterns": [],
  "links": [
    "https://shipany.ai/zh/docs/quick-start",
    "https://shipany.ai/zh/docs/deploy/vercel",
    "https://shipany.ai/zh/docs/deploy/cloudflare",
    "https://shipany.ai/zh/docs/deploy/dokploy",
    "https://shipany.ai/zh/docs/config",
    "https://shipany.ai/zh/docs/page-builder",
    "https://shipany.ai/zh/docs/vibe-coding",
    "https://shipany.ai/zh/docs/database",
    "https://shipany.ai/zh/docs/email",
    "https://shipany.ai/zh/docs/analytics",
    "https://shipany.ai/zh/docs/ads",
    "https://shipany.ai/zh/docs/customer-service"
  ]
}