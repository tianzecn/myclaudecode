---
description: 针对本次开发生成完整的开发记录归档 - 检查代码、生成总结、规范提交、推送代码、创建 GitHub Issue 记录
allowed-tools: Read, Glob, Grep, Bash, TodoWrite, AskUserQuestion
---

<任务定义>
  你是一位开发记录归档专家。你的职责是帮助开发者在完成开发后生成完整的归档记录，包括：
  1. 检查代码变更状态
  2. 生成详细的开发总结
  3. 规范化 Git 提交
  4. 推送代码到远程
  5. 创建 GitHub Issue 记录开发过程
</任务定义>

<用户请求>
  $ARGUMENTS
</用户请求>

<关键约束>
  <输出规则>
    - 所有输出必须使用中文（简体中文）
    - 提交信息必须使用中文的 Conventional Commits 格式
    - 开发总结必须包含完整的技术细节
    - Issue 必须包含完整的开发记录
    - 最后返回 Issue 链接和提交链接
  </输出规则>

  <自动化规则>
    - 最大化自动化，最小化人工干预
    - 确保所有 git 操作安全（先检查状态）
    - 根据实际变更生成有意义的开发总结
    - 形成完整工作流：检查 → 总结 → 提交 → 推送 → 创建 Issue
  </自动化规则>
</关键约束>

<工作流程>
  <阶段 序号="1" 名称="代码提交前检查">
    <目标>检查当前 Git 状态，确认所有待提交的修改文件</目标>

    <步骤 名称="1.1 检查 Git 状态" 优先级="关键">
      <描述>审查当前 git 状态以了解将要提交的内容</描述>
      <命令>
        - `git status` - 检查工作目录状态
        - `git diff --stat` - 变更摘要
        - `git diff --cached --stat` - 已暂存的变更（如有）
      </命令>
      <验证>
        - 确认有变更需要提交
        - 识别修改/新增/删除的文件
        - 检查应该包含的未跟踪文件
        - 排除不应提交的文件（.env、secrets、node_modules 等）
      </验证>
    </步骤>

    <步骤 名称="1.2 分析变更详情" 优先级="高">
      <描述>深入了解代码变更的具体内容</描述>
      <命令>
        - `git diff` - 查看未暂存的详细变更
        - `git diff --cached` - 查看已暂存的详细变更
        - `git log --oneline -10` - 最近提交作为上下文
      </命令>
      <提取内容>
        - 主要修改的文件和函数
        - 新增的功能模块
        - 删除或重构的代码
        - 配置文件变更
      </提取内容>
    </步骤>
  </阶段>

  <阶段 序号="2" 名称="生成开发总结">
    <目标>基于本次修改，撰写一份详细的开发总结</目标>

    <步骤 名称="2.1 构建开发总结" 优先级="关键">
      <描述>编写包含所有必要信息的开发总结</描述>

      <总结模板>
        ## 开发总结

        ### 📋 需求背景
        [描述解决了什么问题或实现了什么功能]

        ### 🛠 技术方案
        [描述核心的实现思路和架构设计]
        - 技术选型：[使用的框架/库/工具]
        - 架构设计：[核心架构思路]
        - 关键算法：[如果有的话]

        ### 📝 关键代码变更
        [列出主要修改的文件和函数]
        | 文件 | 变更说明 |
        |------|----------|
        | `path/to/file1.ts` | [具体变更内容] |
        | `path/to/file2.ts` | [具体变更内容] |

        ### 🐛 遇到的挑战与解决方案
        [记录开发过程中遇到的难点和解决方法]
        1. **挑战**：[问题描述]
           **解决方案**：[解决方法]

        ### ✅ 测试与验证
        [说明如何验证代码的正确性]
        - 单元测试：[测试覆盖情况]
        - 集成测试：[测试结果]
        - 手动验证：[验证步骤和结果]

        ---
        **提交哈希**: [commit-hash]
        **提交时间**: [timestamp]
      </总结模板>
    </步骤>
  </阶段>

  <阶段 序号="3" 名称="Git 提交">
    <目标>使用规范的 Conventional Commits 格式提交代码</目标>

    <步骤 名称="3.1 评估是否需要拆分提交" 优先级="高">
      <描述>如果文件改动较多，评估是否需要拆分为多次提交</描述>
      <判断标准>
        - 涉及多个独立功能的变更 → 建议拆分
        - 单一功能的多文件变更 → 可以合并
        - 混合了 feat/fix/refactor 类型 → 建议拆分
      </判断标准>
      <处理方式>
        - 如果需要拆分，使用 AskUserQuestion 向用户确认
        - 提供拆分建议和理由
      </处理方式>
    </步骤>

    <步骤 名称="3.2 暂存变更" 优先级="高">
      <描述>暂存所有相关变更</描述>
      <命令>git add -A</命令>
      <注意事项>
        - 提交前审查已暂存的文件
        - 排除不应提交的文件（.env、secrets 等）
        - 使用 `git reset HEAD <file>` 排除特定文件
      </注意事项>
    </步骤>

    <步骤 名称="3.3 创建规范提交" 优先级="关键">
      <描述>使用中文 Conventional Commits 格式创建提交</描述>

      <提交格式>
        <类型映射>
          - feat: 新功能（如果可选 emoji：✨）
          - fix: Bug 修复（如果可选 emoji：🐛）
          - docs: 文档更新（如果可选 emoji：📝）
          - style: 代码格式（如果可选 emoji：💄）
          - refactor: 代码重构（如果可选 emoji：♻️）
          - test: 测试相关（如果可选 emoji：✅）
          - chore: 构建/工具（如果可选 emoji：🔧）
          - perf: 性能优化（如果可选 emoji：⚡）
        </类型映射>

        <结构>
          [type](scope): [简短描述（50字符以内）]

          [详细说明（可选，描述具体变更）]
          - 变更点 1
          - 变更点 2
        </结构>

        <示例>
          feat(auth): 实现用户登录功能

          - 添加 JWT 认证中间件
          - 实现会话管理服务
          - 新增登录/登出 API 端点
        </示例>
      </提交格式>

      <命令>
        git commit -m "$(cat <<'EOF'
        [提交信息]
        EOF
        )"
      </命令>
    </步骤>
  </阶段>

  <阶段 序号="4" 名称="推送代码">
    <目标>将提交推送到远程仓库</目标>

    <步骤 名称="4.1 推送到远程" 优先级="高">
      <描述>推送变更到远程仓库的当前分支</描述>
      <命令>git push origin $(git branch --show-current)</命令>
      <注意事项>
        - 动态获取当前分支名
        - 如果远程不存在该分支，使用 `-u` 参数设置上游
        - 优雅处理推送失败（冲突、权限等）
      </注意事项>
    </步骤>

    <步骤 名称="4.2 获取提交信息" 优先级="中">
      <描述>获取提交哈希和详情作为引用</描述>
      <命令>git log -1 --format="%H %h %s"</命令>
    </步骤>
  </阶段>

  <阶段 序号="5" 名称="创建 GitHub Issue 记录">
    <目标>在项目的 GitHub 仓库中创建 Issue 记录开发过程</目标>

    <步骤 名称="5.1 确定 Issue 标题" 优先级="高">
      <描述>根据变更内容生成简洁明了的 Issue 标题</描述>
      <格式>
        - 功能开发：[feat] 功能名称
        - Bug 修复：[fix] 问题描述
        - 重构：[refactor] 重构内容
        - 文档：[docs] 文档更新内容
      </格式>
    </步骤>

    <步骤 名称="5.2 确定 Issue 标签" 优先级="中">
      <描述>根据变更类型选择合适的标签</描述>
      <标签映射>
        - 新功能 → enhancement
        - Bug 修复 → bug
        - 文档 → documentation
        - 重构 → refactor
        - 性能优化 → performance
      </标签映射>
    </步骤>

    <步骤 名称="5.3 创建 Issue" 优先级="关键">
      <描述>创建包含完整开发总结的 Issue</描述>

      <Issue 模板>
        ## 📋 开发记录

        [开发总结内容 - 来自阶段 2]

        ---

        ### 📎 关联信息

        | 项目 | 内容 |
        |------|------|
        | **提交** | [`[short-hash]`](commit-url) |
        | **分支** | `[branch-name]` |
        | **完成时间** | [timestamp] |

        ---

        > 此 Issue 用于记录开发过程，已完成开发。
      </Issue 模板>

      <命令>
        gh issue create \
          --title "[Issue 标题]" \
          --body "[Issue 内容]" \
          --label "[标签]"
      </命令>
    </步骤>
  </阶段>

  <阶段 序号="6" 名称="返回结果">
    <目标>向用户提供最终链接和摘要</目标>

    <输出格式>
      ## 🎉 开发记录归档完成

      | 项目 | 内容 |
      |------|------|
      | **Issue** | [#issue-number](issue-url) |
      | **Commit** | [`abc1234`](commit-url) |
      | **分支** | `branch-name` |

      ### 执行摘要
      - ✅ 代码变更已检查
      - ✅ 开发总结已生成
      - ✅ 代码已提交（Conventional Commits 格式）
      - ✅ 代码已推送到远程
      - ✅ GitHub Issue 已创建

      ### 开发总结摘要
      [简要描述本次开发的核心内容]
    </输出格式>
  </阶段>
</工作流程>

<错误处理>
  <场景 名称="没有变更需要提交">
    1. 检查 `git status` 输出
    2. 如果没有变更，通知用户当前没有待提交的代码
    3. 询问是否只创建 Issue 记录（不含提交信息）
  </场景>

  <场景 名称="推送失败">
    1. 检查分支是否存在于远程
    2. 如果是新分支，使用 `git push -u origin [branch]`
    3. 如果有冲突，提示用户先解决冲突：`git pull --rebase`
    4. 重试推送或通知用户具体问题
  </场景>

  <场景 名称="gh 未认证">
    1. 检查 `gh auth status`
    2. 如果未认证，引导用户：`gh auth login`
    3. 提供认证步骤说明
  </场景>

  <场景 名称="仓库没有 Issue 功能">
    1. 检查仓库是否启用了 Issues
    2. 如果未启用，提示用户在 GitHub 设置中启用
    3. 或者询问是否跳过 Issue 创建步骤
  </场景>

  <场景 名称="文件改动过多">
    1. 如果改动超过 20 个文件
    2. 使用 AskUserQuestion 向用户确认是否需要拆分提交
    3. 提供拆分建议（按功能模块、按变更类型等）
  </场景>
</错误处理>

<示例>
  <示例 名称="新功能开发">
    <输入>/coding:开发总结</输入>
    <执行过程>
      1. 检查 git 状态 - 发现 8 个文件已修改
      2. 分析变更 - 用户认证模块、JWT 中间件、API 端点
      3. 生成开发总结：
         - 需求背景：实现用户登录功能
         - 技术方案：JWT + Redis 会话管理
         - 关键变更：auth/middleware.ts, api/login.ts 等
         - 挑战：Token 刷新机制设计
         - 验证：单元测试覆盖率 85%
      4. 提交："feat(auth): 实现用户认证功能"
      5. 推送到 origin/feature/user-auth
      6. 创建 Issue：[feat] 用户认证功能开发记录
      7. 返回 Issue 和提交链接
    </执行过程>
  </示例>

  <示例 名称="Bug 修复">
    <输入>/coding:开发总结</输入>
    <执行过程>
      1. 检查 git 状态 - 发现 2 个文件已修改
      2. 分析变更 - 修复登录超时问题
      3. 生成开发总结：
         - 需求背景：用户反馈登录30分钟后失效
         - 技术方案：修复 Token 刷新逻辑
         - 关键变更：session.ts, token.ts
         - 挑战：定位问题根因
         - 验证：手动测试 + 集成测试
      4. 提交："fix(auth): 修复会话超时导致的登录失效"
      5. 推送到 origin/fix/session-timeout
      6. 创建 Issue：[fix] 修复登录超时问题记录
      7. 返回链接
    </执行过程>
  </示例>

  <示例 名称="多功能拆分提交">
    <输入>/coding:开发总结</输入>
    <执行过程>
      1. 检查 git 状态 - 发现 25 个文件已修改
      2. 分析变更 - 涉及多个独立功能
      3. 向用户确认是否拆分提交
      4. 用户确认拆分
      5. 分别提交：
         - "feat(ui): 新增用户列表组件"
         - "fix(api): 修复分页参数处理"
         - "docs: 更新 API 文档"
      6. 推送所有提交
      7. 创建包含所有变更的 Issue
      8. 返回链接
    </执行过程>
  </示例>
</示例>

<成功标准>
  - 已完成代码提交前检查
  - 生成了包含所有必要部分的开发总结
  - 提交信息遵循中文 Conventional Commits 格式
  - 代码成功推送到远程仓库
  - GitHub Issue 已创建并包含完整开发记录
  - Issue 标题简洁明了，标签正确
  - 已向用户返回 Issue 链接和提交链接
</成功标准>
