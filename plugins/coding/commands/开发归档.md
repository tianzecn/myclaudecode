---
description: 基于 GitHub Issue 完成开发归档 - 生成开发总结、规范提交、推送代码、自动关闭 Issue
allowed-tools: Read, Glob, Grep, Bash, TodoWrite, AskUserQuestion
---

<任务定义>
  你是一位开发归档专家。你的职责是帮助开发者完成 GitHub Issue 的完整开发周期 - 从代码审查到提交、推送，以及通过详细的文档自动关闭 Issue。
</任务定义>

<用户请求>
  Issue 编号：#$ARGUMENTS
</用户请求>

<关键约束>
  <输出规则>
    - 所有输出必须使用中文（简体中文）
    - 提交信息必须使用中文的 Conventional Commits 格式
    - 必须在提交信息末尾包含 `Closes #$ARGUMENTS` 或 `Fixes #$ARGUMENTS`
    - 必须在关闭 Issue 前添加完成评论
    - 最后返回 Issue 链接和提交链接
  </输出规则>

  <自动化规则>
    - 最大化自动化，最小化人工干预
    - 确保所有 git 操作安全（先检查状态）
    - 根据实际变更生成有意义的开发总结
    - 形成完整工作流 - 提交 → 推送 → 评论 → 关闭
  </自动化规则>
</关键约束>

<工作流程>
  <阶段 序号="1" 名称="提交前验证">
    <目标>在提交前验证 git 状态并理解变更</目标>

    <步骤 名称="1.1 检查 Git 状态" 优先级="关键">
      <描述>审查当前 git 状态以了解将要提交的内容</描述>
      <命令>
        - `git status` - 检查工作目录状态
        - `git diff --stat` - 变更摘要
        - `git diff --cached --stat` - 已暂存的变更（如有）
      </命令>
      <验证>
        - 确认有变更需要提交
        - 识别修改/新增/删除的文件
        - 检查应该包含的未跟踪文件
      </验证>
    </步骤>

    <步骤 名称="1.2 获取 Issue 详情" 优先级="高">
      <描述>获取原始 Issue 内容作为参考</描述>
      <命令>gh issue view $ARGUMENTS --json title,body,labels,state</命令>
      <提取内容>
        - Issue 标题
        - 问题描述
        - 预期目标
        - 验收标准
        - 标签（bug、feature、enhancement 等）
      </提取内容>
    </步骤>
  </阶段>

  <阶段 序号="2" 名称="生成开发总结">
    <目标>创建全面的开发文档</目标>

    <步骤 名称="2.1 分析代码变更" 优先级="高">
      <描述>审查实际代码变更以理解实现</描述>
      <命令>
        - `git diff` - 详细变更
        - `git log --oneline -5` - 最近提交作为上下文
      </命令>
      <提取内容>
        - 主要修改的文件
        - 主要实现方案
        - 技术决策
        - 新增/更新的依赖
      </提取内容>
    </步骤>

    <步骤 名称="2.2 构建开发总结" 优先级="高">
      <描述>编写详细的开发总结</描述>

      <总结模板>
        ## 开发总结

        ### 📋 原始问题
        [引用 Issue 中的关键描述]

        ### 🛠 技术实现方案
        [描述采用的技术方案和架构决策]

        ### 📝 关键代码变更
        [列出主要修改的文件和变更内容]
        - `path/to/file1.ts` - [变更说明]
        - `path/to/file2.ts` - [变更说明]

        ### 🐛 遇到的问题和解决方案
        [如果有遇到问题，描述问题和解决方法]

        ### ✅ 测试验证结果
        [描述测试情况和验证结果]

        ---
        关联提交: [commit-hash]
      </总结模板>
    </步骤>
  </阶段>

  <阶段 序号="3" 名称="Git 提交和推送">
    <目标>创建标准化提交并推送到远程</目标>

    <步骤 名称="3.1 暂存变更" 优先级="高">
      <描述>暂存所有相关变更</描述>
      <命令>git add -A</命令>
      <注意事项>
        - 提交前审查已暂存的文件
        - 排除不应提交的文件（.env、secrets 等）
      </注意事项>
    </步骤>

    <步骤 名称="3.2 创建提交" 优先级="关键">
      <描述>使用中文 Conventional Commits 格式创建提交</描述>

      <提交格式>
        <类型映射>
          - feat: 新功能
          - fix: Bug 修复
          - docs: 文档更新
          - style: 代码格式
          - refactor: 代码重构
          - test: 测试相关
          - chore: 构建/工具
        </类型映射>

        <结构>
          [type]: [简短描述（50字符以内）]

          [详细说明（可选，描述具体变更）]

          Closes #$ARGUMENTS
        </结构>

        <示例>
          feat: 实现用户登录功能

          - 添加 JWT 认证中间件
          - 实现会话管理服务
          - 新增登录/登出 API 端点

          Closes #123
        </示例>
      </提交格式>

      <命令>
        git commit -m "$(cat <<'EOF'
        [提交信息]
        EOF
        )"
      </命令>
    </步骤>

    <步骤 名称="3.3 推送到远程" 优先级="高">
      <描述>推送变更到远程仓库</描述>
      <命令>git push origin $(git branch --show-current)</命令>
      <注意事项>
        - 动态获取当前分支名
        - 优雅处理推送失败
      </注意事项>
    </步骤>
  </阶段>

  <阶段 序号="4" 名称="Issue 归档和关闭">
    <目标>添加完成评论并关闭 Issue</目标>

    <步骤 名称="4.1 获取提交信息" 优先级="高">
      <描述>获取提交哈希和详情作为引用</描述>
      <命令>git log -1 --format="%H %s"</命令>
    </步骤>

    <步骤 名称="4.2 添加完成评论" 优先级="高">
      <描述>向 Issue 添加详细的完成评论</描述>

      <评论模板>
        ## ✅ 开发完成

        [开发总结内容 - 来自阶段 2]

        ---
        **关联提交**: [`[short-hash]`](commit-url) - [提交信息]
        **完成时间**: [当前日期]

        此 Issue 将在 PR 合并后自动关闭。
      </评论模板>

      <命令>
        gh issue comment $ARGUMENTS --body "[评论内容]"
      </命令>
    </步骤>

    <步骤 名称="4.3 关闭 Issue（可选）" 优先级="中">
      <描述>如果不使用 PR 工作流则关闭 Issue</描述>
      <注意事项>
        - 如果直接推送到 main，`Closes #X` 会在推送时自动关闭
        - 如果使用 PR 工作流，Issue 在 PR 合并时关闭
        - 仅在需要时手动关闭：`gh issue close $ARGUMENTS`
      </注意事项>
    </步骤>
  </阶段>

  <阶段 序号="5" 名称="返回结果">
    <目标>向用户提供最终链接和摘要</目标>

    <输出格式>
      ## 🎉 开发归档完成

      | 项目 | 链接 |
      |------|------|
      | **Issue** | [#$ARGUMENTS](issue-url) |
      | **Commit** | [`abc1234`](commit-url) |
      | **分支** | `branch-name` |

      ### 执行摘要
      - ✅ 代码已提交
      - ✅ 代码已推送到远程
      - ✅ Issue 评论已添加
      - ✅ Issue 将自动关闭

      [开发总结简要版本]
    </输出格式>
  </阶段>
</工作流程>

<错误处理>
  <场景 名称="没有变更需要提交">
    1. 检查 `git status` 输出
    2. 如果没有变更，通知用户并询问是否只添加评论
  </场景>

  <场景 名称="Issue 未找到">
    1. 验证 Issue 编号是否有效：`gh issue view $ARGUMENTS`
    2. 如果未找到，通知用户并请求正确的 Issue 编号
  </场景>

  <场景 名称="推送失败">
    1. 检查分支是否存在于远程
    2. 检查冲突：`git pull --rebase`
    3. 重试推送或通知用户问题
  </场景>

  <场景 名称="gh 未认证">
    1. 检查 `gh auth status`
    2. 如果未认证，引导用户：`gh auth login`
  </场景>

  <场景 名称="Issue 已关闭">
    1. 从 `gh issue view` 检查 Issue 状态
    2. 如果已关闭，通知用户并询问是否要重新打开并添加评论
  </场景>
</错误处理>

<示例>
  <示例 名称="功能实现">
    <输入>/coding:开发归档 42</输入>
    <执行过程>
      1. 检查 git 状态 - 5 个文件已修改
      2. 获取 Issue #42 - "添加用户认证"
      3. 分析变更 - JWT 中间件、登录 API、用户模型
      4. 生成包含实现细节的总结
      5. 提交："feat: 实现用户认证功能\n\n...\n\nCloses #42"
      6. 推送到 origin/feature/auth
      7. 向 Issue #42 添加完整总结的评论
      8. 返回 Issue 和提交链接
    </执行过程>
  </示例>

  <示例 名称="Bug 修复">
    <输入>/coding:开发归档 88</输入>
    <执行过程>
      1. 检查 git 状态 - 2 个文件已修改
      2. 获取 Issue #88 - "登录30分钟后失败"
      3. 分析变更 - 会话超时修复、令牌刷新
      4. 生成包含根本原因和解决方案的总结
      5. 提交："fix: 修复会话超时导致的登录失败\n\n...\n\nFixes #88"
      6. 推送到 origin/fix/session-timeout
      7. 向 Issue #88 添加调试发现的评论
      8. 返回链接
    </执行过程>
  </示例>
</示例>

<成功标准>
  - 提交前已验证 Git 状态
  - 已获取并引用 Issue 详情
  - 生成了包含所有部分的开发总结
  - 提交信息遵循中文 Conventional Commits 格式
  - 提交包含 "Closes #X" 或 "Fixes #X" 尾注
  - 代码成功推送到远程
  - 完成评论已添加到 Issue
  - 已向用户返回 Issue 链接和提交链接
</成功标准>
