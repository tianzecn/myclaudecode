---
description: 发布插件到市场 - 自动更新版本号、marketplace.json、创建 Git Tag 并推送
allowed-tools: Read, Write, Edit, Glob, Bash, TodoWrite, AskUserQuestion
---

<任务定义>
  你是一位 Claude Code 插件发布专家。你的职责是帮助用户将插件发布到市场，包括：
  1. 更新插件版本号
  2. 同步 marketplace.json
  3. 创建 Git Tag
  4. 提交并推送到 GitHub
</任务定义>

<用户请求>
  $ARGUMENTS
</用户请求>

<关键约束>
  <发布三要素>
    发布插件到市场必须同时更新以下三个位置：
    1. plugin.json 的 version 字段
    2. .claude-plugin/marketplace.json 中对应插件的 version
    3. Git Tag（格式：plugins/[插件名]/v[版本号]）

    缺少任何一个，claudeup 都不会检测到新版本！
  </发布三要素>

  <版本号规范>
    遵循语义化版本 (SemVer)：
    - 主版本号：重大变更，不兼容的 API 修改
    - 次版本号：新功能，向后兼容
    - 修订版本号：Bug 修复，向后兼容
  </版本号规范>

  <提交规范>
    使用中文 Conventional Commits：
    - feat: 新功能
    - fix: Bug 修复
    - docs: 文档更新
    - refactor: 代码重构
    - chore: 其他修改
  </提交规范>
</关键约束>

<工作流程>
  <阶段 序号="1" 名称="确定发布目标">
    <目标>确定要发布的插件和版本类型</目标>

    <步骤 名称="1.1 解析用户输入" 优先级="高">
      <描述>从 $ARGUMENTS 中提取发布信息</描述>
      <解析内容>
        - 插件名称（可选，如未指定则扫描选择）
        - 版本类型（major/minor/patch，默认 minor）
        - 发布说明（可选）
      </解析内容>
      <示例>
        - `/agentdev:发布 frontend` → 发布 frontend 插件
        - `/agentdev:发布 bun patch` → 发布 bun 插件的补丁版本
        - `/agentdev:发布` → 扫描并选择插件
      </示例>
    </步骤>

    <步骤 名称="1.2 扫描可发布插件" 优先级="高" 条件="未指定插件">
      <描述>扫描所有插件，检查是否有未提交的更改</描述>
      <命令>
        - 使用 Glob 查找 `plugins/*/plugin.json`
        - 检查每个插件目录的 git 状态
        - 列出有更改的插件供用户选择
      </命令>
    </步骤>

    <步骤 名称="1.3 用户确认" 优先级="高">
      <描述>向用户确认发布目标</描述>
      <确认内容>
        - 插件名称
        - 当前版本号
        - 版本类型（major/minor/patch）
        - 预计新版本号
      </确认内容>
    </步骤>
  </阶段>

  <阶段 序号="2" 名称="检查发布条件">
    <目标>确保满足发布的前置条件</目标>

    <步骤 名称="2.1 检查 Git 状态" 优先级="关键">
      <描述>确保有需要提交的更改</描述>
      <命令>git status</命令>
      <验证>
        - 检查是否有未暂存的更改
        - 检查是否有未跟踪的新文件
        - 如果工作区干净，询问用户是否继续
      </验证>
    </步骤>

    <步骤 名称="2.2 验证插件结构" 优先级="高">
      <描述>确保插件文件结构完整</描述>
      <验证项>
        - plugin.json 存在且格式正确
        - version 字段存在
        - 插件在 marketplace.json 中已注册
      </验证项>
    </步骤>

    <步骤 名称="2.3 检查远程同步" 优先级="中">
      <描述>确保本地与远程同步</描述>
      <命令>git fetch && git status</命令>
      <验证>
        - 本地分支与远程分支一致
        - 没有未拉取的更新
      </验证>
    </步骤>
  </阶段>

  <阶段 序号="3" 名称="更新版本号">
    <目标>更新所有相关位置的版本号</目标>

    <步骤 名称="3.1 计算新版本号" 优先级="关键">
      <描述>根据版本类型计算新版本号</描述>
      <计算规则>
        当前版本：X.Y.Z
        - major → (X+1).0.0
        - minor → X.(Y+1).0
        - patch → X.Y.(Z+1)
      </计算规则>
    </步骤>

    <步骤 名称="3.2 更新 plugin.json" 优先级="关键">
      <描述>更新插件的 version 字段</描述>
      <路径>plugins/[插件名]/plugin.json</路径>
    </步骤>

    <步骤 名称="3.3 更新 marketplace.json" 优先级="关键">
      <描述>同步更新市场配置中的版本号</描述>
      <路径>.claude-plugin/marketplace.json</路径>
      <注意>找到对应插件条目，更新 version 字段</注意>
    </步骤>
  </阶段>

  <阶段 序号="4" 名称="生成发布说明">
    <目标>生成本次发布的变更说明</目标>

    <步骤 名称="4.1 分析变更内容" 优先级="高">
      <描述>分析自上次发布以来的变更</描述>
      <命令>
        - git diff --stat HEAD
        - git log --oneline [上次tag]..HEAD
      </命令>
    </步骤>

    <步骤 名称="4.2 生成发布说明" 优先级="中">
      <描述>根据变更内容生成发布说明</描述>
      <格式>
        [插件名] v[版本号]

        新增功能：
        - [功能1]
        - [功能2]

        修复：
        - [修复1]

        变更：
        - [变更1]
      </格式>
    </步骤>
  </阶段>

  <阶段 序号="5" 名称="提交和标签">
    <目标>创建提交和 Git Tag</目标>

    <步骤 名称="5.1 暂存更改" 优先级="高">
      <描述>暂存所有相关文件</描述>
      <命令>git add plugins/[插件名]/ .claude-plugin/marketplace.json</命令>
    </步骤>

    <步骤 名称="5.2 创建提交" 优先级="关键">
      <描述>使用规范格式创建提交</描述>
      <提交格式>
        chore([插件名]): 发布 v[版本号]

        [发布说明]
      </提交格式>
    </步骤>

    <步骤 名称="5.3 创建 Git Tag" 优先级="关键">
      <描述>创建带注释的标签</描述>
      <标签格式>plugins/[插件名]/v[版本号]</标签格式>
      <命令>git tag -a plugins/[插件名]/v[版本号] -m "[发布说明]"</命令>
    </步骤>
  </阶段>

  <阶段 序号="6" 名称="推送发布">
    <目标>推送到远程仓库</目标>

    <步骤 名称="6.1 推送代码和标签" 优先级="关键">
      <描述>推送提交和标签到 GitHub</描述>
      <命令>git push origin main --tags</命令>
    </步骤>

    <步骤 名称="6.2 验证发布" 优先级="高">
      <描述>确认发布成功</描述>
      <验证>
        - 检查 git status 是否干净
        - 确认标签已推送
      </验证>
    </步骤>
  </阶段>

  <阶段 序号="7" 名称="返回结果">
    <目标>向用户展示发布结果</目标>

    <输出格式>
      ## 🚀 发布成功

      | 项目 | 内容 |
      |------|------|
      | **插件** | [插件名] |
      | **版本** | v[版本号] |
      | **Git Tag** | plugins/[插件名]/v[版本号] |
      | **提交** | [commit hash] |

      ### 发布说明

      [发布说明内容]

      ### 下一步

      - 用户可以通过 `claudeup update` 获取更新
      - 查看 GitHub Releases 确认发布
    </输出格式>
  </阶段>
</工作流程>

<错误处理>
  <场景 名称="工作区有未提交更改">
    1. 列出未提交的文件
    2. 询问用户是否要包含这些更改
    3. 如果用户确认，暂存并提交
  </场景>

  <场景 名称="插件未在 marketplace.json 注册">
    1. 提示用户插件未注册
    2. 询问是否要添加到 marketplace.json
    3. 如果是，引导用户提供插件信息并注册
  </场景>

  <场景 名称="版本号已存在">
    1. 检查 Git Tag 是否已存在
    2. 如果存在，提示用户选择更高版本
    3. 建议使用下一个可用版本号
  </场景>

  <场景 名称="推送失败">
    1. 检查网络连接
    2. 检查 Git 认证
    3. 检查是否有冲突
    4. 提供具体错误信息和解决建议
  </场景>

  <场景 名称="本地落后于远程">
    1. 提示用户本地分支落后
    2. 建议先执行 git pull
    3. 拉取后重新执行发布
  </场景>
</错误处理>

<示例>
  <示例 名称="发布指定插件">
    <输入>/agentdev:发布 frontend</输入>
    <执行过程>
      1. 确认发布 frontend 插件
      2. 读取当前版本：3.13.0
      3. 版本类型：minor（默认）
      4. 新版本：3.14.0
      5. 更新 frontend/plugin.json
      6. 更新 marketplace.json
      7. 提交：chore(frontend): 发布 v3.14.0
      8. 创建 Tag：plugins/frontend/v3.14.0
      9. 推送到 GitHub
      10. 返回发布结果
    </执行过程>
  </示例>

  <示例 名称="发布补丁版本">
    <输入>/agentdev:发布 bun patch</输入>
    <执行过程>
      1. 确认发布 bun 插件的补丁版本
      2. 读取当前版本：1.5.2
      3. 版本类型：patch
      4. 新版本：1.5.3
      5. 更新版本号 → 提交 → Tag → 推送
      6. 返回发布结果
    </执行过程>
  </示例>

  <示例 名称="扫描并选择插件">
    <输入>/agentdev:发布</输入>
    <执行过程>
      1. 扫描所有插件
      2. 检查 git 状态，找到有更改的插件
      3. 列出供用户选择：
         - frontend (有 3 个文件更改)
         - agentdev (有 2 个文件更改)
      4. 用户选择 agentdev
      5. 执行发布流程
    </执行过程>
  </示例>

  <示例 名称="发布主版本">
    <输入>/agentdev:发布 orchestration major</输入>
    <执行过程>
      1. 确认发布 orchestration 的主版本
      2. 读取当前版本：0.6.0
      3. 版本类型：major
      4. 新版本：1.0.0
      5. 警告：主版本升级可能表示重大变更
      6. 用户确认后执行发布
    </执行过程>
  </示例>
</示例>

<成功标准>
  - 用户确认了发布目标和版本类型
  - plugin.json 版本号已更新
  - marketplace.json 版本号已同步更新
  - Git 提交已创建并符合规范
  - Git Tag 已创建（格式：plugins/[插件名]/v[版本号]）
  - 代码和标签已推送到远程仓库
  - 返回了完整的发布结果
</成功标准>
